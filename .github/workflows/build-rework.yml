name: Bygg og deploy svp rework
on:
    push:
        branches:
            - 'ny-svp'

jobs:
    test:
        name: Run tests
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - name: Install Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 18

            - uses: pnpm/action-setup@v2
              name: Install pnpm
              with:
                  version: 8
                  run_install: false

            - name: Get pnpm store directory
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

            - uses: actions/cache@v3
              name: Setup pnpm cache
              with:
                  path: ${{ env.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: cd til svp
              run: cd apps/svangerskapspengesoknad

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run tests
              run: pnpm exec turbo test

    create-build-version:
        name: Create build version
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Print context
              run: echo "$JSON"
              env:
                  JSON: ${{ toJSON(github) }}
            - name: Generate build version
              id: generate-build-version
              run: echo "build-version=$(date +%Y.%m.%d.%H%M%S)-$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_OUTPUT
            - name: Generate cache tags
              shell: bash
              id: generate-cache-tags
              env:
                  GITHUB_REF_NAME: ${{ github.ref_name }}
              run: |
                  GITHUB_REF_NAME=${GITHUB_REF_NAME//\//_}
                  echo "cache-tag=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT
        outputs:
            build-version: ${{ steps.generate-build-version.outputs.build-version }}
            cache-tag: ${{ steps.generate-cache-tags.outputs.cache-tag }}

    build-platform-images:
        strategy:
            matrix:
                platform: ['amd64']
        name: Build platform images
        needs: create-build-version
        permissions:
            contents: read
            packages: write
            id-token: write
        uses: navikt/fp-gha-workflows/.github/workflows/build-app-frontend-pnpm.yml@main
        with:
            push-image: true
            platform: ${{ matrix.platform }}
            cache-tag: ${{ needs.create-build-version.outputs.cache-tag }}
        secrets: inherit

    create-manifest:
        runs-on: ubuntu-latest
        name: Create multiplatform image
        needs:
            - build-platform-images
            - test
            - create-build-version
        permissions:
            contents: read
            packages: write
        steps:
            - name: Print build version
              run: echo "Generated build-version is ${{ needs.create-build-version.outputs.build-version }}"

            - name: Login to GitHub Packages Docker Registry
              uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Tag image
              run: |
                  docker buildx imagetools create \
                    ghcr.io/${{ github.repository }}/svangerskapspengesoknad-rework:amd64-${{ github.sha }} \
                    -t ghcr.io/${{ github.repository }}/svangerskapspengesoknad-rework:${{ needs.create-build-version.outputs.build-version }}


    promote-svangerskapspengesoknad-dev:
        name: Deploy svangerskapspengesoknad rework til dev
        runs-on: 'ubuntu-latest'
        needs:
            - create-manifest
            - create-build-version
        steps:
            - uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # ratchet:actions/checkout@v4
            - name: Deploy svp rework
              uses: nais/deploy/actions/deploy@b2c5fbf3fc4d777a36b311da70d9ff429416b552 # ratchet:nais/deploy/actions/deploy@v1
              env:
                  PRINT_PAYLOAD: true
                  APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
                  CLUSTER: dev-gcp
                  RESOURCE: .deploy/naiserator_rework.yaml
                  IMAGE: ghcr.io/${{ github.repository }}/svangerskapspengesoknad-rework:${{ needs.create-build-version.outputs.build-version }}
