name: Bygg server
on:
  workflow_dispatch:
  push:
    branches:
      - 'master'
    paths:
      - 'server/**'
      - '.github/workflows/build-server.yml'
  schedule:
    - cron: '45 23 28 * *' # "At 11:45 PM, on day 28 of the month"

jobs:
  build:
    name: Build
    permissions:
      packages: write
      id-token: write
    uses: navikt/fp-gha-workflows/.github/workflows/build-docker.yml@main
    with:
      push-image: ${{ github.ref_name == 'master' }}
      docker_context: './server'
      app_name: '/server'
    secrets: inherit

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Set outputs
      shell: bash
      id: set-outputs
      run: |
        echo "New server version build: ${{ needs.build.outputs.version }} ðŸŽ¸" >> $GITHUB_STEP_SUMMARY
        echo "Digest: ${{ needs.build.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
        echo "Salsa: ${{ needs.attest-sign.outputs.sbom }}" >> $GITHUB_STEP_SUMMARY
