name: Bundle-st√∏rrelsessammenligning

on:
  pull_request:
    branches:
      - "**"
    paths:
      - "apps/**"
      - "packages/**"
      - ".github/workflows/bundle-size.yml"

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  compare:
    name: Sammenligne bundle-st√∏rrelse
    runs-on: ubuntu-latest
    outputs:
      output_foreldrepengeoversikt: ${{ steps.compare.outputs.output_foreldrepengeoversikt }}
      output_foreldrepengesoknad: ${{ steps.compare.outputs.output_foreldrepengesoknad }}
      output_engangsstonad: ${{ steps.compare.outputs.output_engangsstonad }}

    strategy:
      matrix:
        directory:
          - foreldrepengeoversikt
          - foreldrepengesoknad
          - engangsstonad

    defaults:
      run:
        working-directory: apps/${{ matrix.directory }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: https://npm.pkg.github.com/
          scope: "@navikt"

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies (PR branch)
        run: |
          pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.READER_TOKEN }}

      - name: Measure bundle size (PR branch)
        run: |
          pnpm run build > build-output.log
          node ../../scripts/beregn-bundle-size.mjs > pr-bundle-size.json

      - name: Checkout base branch
        run: git checkout ${{ github.event.pull_request.base.ref }}

      - name: Install dependencies (base branch)
        run: pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.READER_TOKEN }}

      - name: Measure bundle size (base branch)
        run: echo '{"name":"Total Size","size":2016.77}' > base-bundle-size.json
#        run: pnpm run build > build-output.log && node beregn-bundle-size.js > base-bundle-size.json

      - name: Compare bundle sizes
        id: compare
        run: |
          echo "Beregner forskjell i bundle-st√∏rrelse..."

          # Extract the 'size' value from the JSON output for both PR and base branches
          PR_SIZE_KB=$(jq '.size' pr-bundle-size.json)
          BASE_SIZE_KB=$(jq '.size' base-bundle-size.json)

          # Convert sizes from kilobytes to bytes
          PR_SIZE=$(echo "$PR_SIZE_KB * 1024" | bc)
          BASE_SIZE=$(echo "$BASE_SIZE_KB * 1024" | bc)

          # Calculate the difference and percentage change
          DIFF=$(echo "$PR_SIZE - $BASE_SIZE" | bc)
          PERCENT_CHANGE=$(echo "scale=2; ($DIFF / $BASE_SIZE) * 100" | bc)

          # Set outputs for use in the next step
          echo "PR_SIZE_${{ matrix.directory }}=$PR_SIZE" >> $GITHUB_OUTPUT
          echo "BASE_SIZE_${{ matrix.directory }}=$BASE_SIZE" >> $GITHUB_OUTPUT
          echo "DIFF_${{ matrix.directory }}=$DIFF" >> $GITHUB_OUTPUT
          echo "PERCENT_CHANGE_${{ matrix.directory }}=$PERCENT_CHANGE" >> $GITHUB_OUTPUT
      - name: Create job summary
        run: |
          # Assign outputs from the previous step to variables
          DIFF=${{ steps.compare.outputs.DIFF }}
          PERCENT_CHANGE=${{ steps.compare.outputs.PERCENT_CHANGE }}
          BASE_SIZE=${{ steps.compare.outputs.BASE_SIZE }}
          PR_SIZE=${{ steps.compare.outputs.PR_SIZE }}

          echo "## ${{ matrix.directory }}" >> bundle-summary.md
          if [ "$DIFF" -gt 0 ]; then
            echo "üî∫ **Bundle-st√∏rrelse √∏kte** med **$(echo "$DIFF / 1024" | bc -l | xargs printf "%.2f") KB** (${PERCENT_CHANGE}%)" >> bundle-summary.md
          elif [ "$DIFF" -lt 0 ]; then
            echo "üîª **Bundle-st√∏rrelse minket** med **$(echo "${DIFF#-} / 1024" | bc -l | xargs printf "%.2f") KB** (${PERCENT_CHANGE#-}%)" >> bundle-summary.md
          else
            echo "‚úÖ **Ingen endring i bundle-st√∏rrelse.**" >> bundle-summary.md
          fi
          echo "**Base-st√∏rrelse:** $(echo "$BASE_SIZE / 1024" | bc -l | xargs printf "%.2f") KB" >> bundle-summary.md
          echo "**PR-st√∏rrelse:** $(echo "$PR_SIZE / 1024" | bc -l | xargs printf "%.2f") KB" >> bundle-summary.md
          echo "" >> bundle-summary.md

          echo "output_${{ matrix.directory }}=$(cat bundle-summary.md)" >> "$GITHUB_OUTPUT"


#      - name: Make artifact name
#        run: |
#          sanitized_name="${{ matrix.directory }}"
#          sanitized_name="${sanitized_name//\//_}"  # Replace slashes with underscores
#          echo "sanitized_name=$sanitized_name" >> $GITHUB_ENV
#
#      - name: Upload bundle summary
#        uses: actions/upload-artifact@v4
#        with:
#          name: bundle-summary-${{ env.sanitized_name }}
#          path: ${{ matrix.directory }}/bundle-summary.md

#      - name: Post comment on PR
#        uses: actions/github-script@v7
#        with:
#          github-token: ${{ secrets.GITHUB_TOKEN }}
#          script: |
#            const prNumber = context.issue.number;
#            const prSize = Number('${{ steps.compare.outputs.PR_SIZE }}');
#            const baseSize = Number('${{ steps.compare.outputs.BASE_SIZE }}');
#            const diff = Number('${{ steps.compare.outputs.DIFF }}');
#            const percentChange = Number('${{ steps.compare.outputs.PERCENT_CHANGE }}').toFixed(2);
#
#            // Function to format bytes into human-readable units
#            const formatBytes = (bytes) => {
#              const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
#              if (bytes == 0) return '0 Bytes';
#              const i = parseInt(Math.floor(Math.log(Math.abs(bytes)) / Math.log(1024)), 10);
#              return `${(bytes / Math.pow(1024, i)).toFixed(2)} ${sizes[i]}`;
#            };
#
#            let message = '';
#
#            if (diff > 0) {
#              message = `üî∫ **Bundle-st√∏rrelse √∏kte** med **${formatBytes(diff)}** (${percentChange}%)\n\n` +
#                        `**Base-st√∏rrelse:** ${formatBytes(baseSize)}\n` +
#                        `**PR-st√∏rrelse:** ${formatBytes(prSize)}`;
#            } else if (diff < 0) {
#              message = `üîª **Bundle-st√∏rrelse minket** med **${formatBytes(Math.abs(diff))}** (${Math.abs(percentChange)}%)\n\n` +
#                        `**Base st√∏rrelse:** ${formatBytes(baseSize)}\n` +
#                        `**PR st√∏rrelse:** ${formatBytes(prSize)}`;
#            } else {
#              message = `‚úÖ **Ingen endring i bundle-st√∏rrelse.**\n\n` +
#                        `**Bundle-st√∏rrelse:** ${formatBytes(prSize)}`;
#            }
#
#            await github.rest.issues.createComment({
#              ...context.repo,
#              issue_number: prNumber,
#              body: message
#            });
  post-summary:
    name: Post Summary Comment
    runs-on: ubuntu-latest
    needs: compare
    steps:
#      - name: Download bundle summaries
#        uses: actions/download-artifact@v4
#        with:
#          merge-multiple: true
#          path: .

#      - name: Display structure of downloaded files
#        run: ls -R
      - name: Concatenate all bundle summaries
        run: |
          echo '${{ toJSON(needs.compare.outputs) }}'

#      - name: Post comment on PR
#        uses: actions/github-script@v7
#        with:
#          github-token: ${{ secrets.GITHUB_TOKEN }}
#          script: |
#            const fs = require('fs');
#            const summary = fs.readFileSync('combined-bundle-summary.md', 'utf8');
#            const prNumber = context.issue.number;
#
#            await github.rest.issues.createComment({
#              ...context.repo,
#              issue_number: prNumber,
#              body: summary
#            });
