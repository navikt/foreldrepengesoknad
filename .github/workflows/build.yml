name: Bygg og deploy
on:
    push:
        branches-ignore: # Kan legge til disse store feature branchene her
            - 'uttaksplanbuilder-rework'
        paths-ignore:
            # - '**.md'
            # - '**.MD'
            - '.gitignore'
            - '.editorconfig'
            - 'LICENCE'
            - 'CODEOWNERS'

jobs:
    build-platform-images:
        strategy:
            matrix:
                platform: ['amd64', 'arm64']
        name: Build platform images
        permissions:
            contents: read
            packages: write
        uses: navikt/fp-gha-workflows/.github/workflows/build-app-frontend-pnpm.yml@main
        with:
            push-image: ${{ github.ref_name == 'master' }} # default: false
            platform: ${{ matrix.platform }}
        secrets: inherit

    build-app:
        strategy:
            matrix:
                app:
                    - 'foreldrepengesoknad'
                    - 'engangsstonad'
                    - 'foreldrepengeoversikt'
                    - 'svangerskapspenger'

        runs-on: ubuntu-latest
        name: Create multiplatform image
        needs: build-platform-images
        if: ${{ github.ref_name == 'master' }}
        permissions:
            contents: read
            packages: write
        steps:
            - name: Generate build version
              id: generate-build-version
              run: echo "build-version=$(date +%Y.%m.%d.%H%M%S)-$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_OUTPUT

            - name: Print build version
              run: echo "Generated build-version is ${{ steps.generate-build-version.outputs.build-version }}"

            - name: Set build version to env variable
              run: echo "Generated build-version is ${{ steps.generate-build-version.outputs.build-version }}"

            - name: Create docker manifest
              run: |
                  docker manifest create \
                    ghcr.io/navikt/foreldrepengesoknad/${{ matrix.app }}:${{ github.sha }} \
                    ghcr.io/navikt/foreldrepengesoknad/${{ matrix.app }}:arm64-${{ github.sha }} \
                    ghcr.io/navikt/foreldrepengesoknad/${{ matrix.app }}:amd64-${{ github.sha }}

            - name: Push manifest
              run: docker manifest push ghcr.io/navikt/foreldrepengesoknad/${{ matrix.app }}:${{ github.sha }}

            - name: Tag image
              run: |
                  docker buildx imagetools create \
                    ghcr.io/navikt/foreldrepengesoknad/${{ matrix.app }}:${{ github.sha }}
                    -t ghcr.io/navikt/foreldrepengesoknad/${{ matrix.app }}:latest \
                    -t ghcr.io/navikt/foreldrepengesoknad/${{ matrix.app }}:${{ steps.generate-build-version.outputs.build-version }}

    promote-foreldrepengesoknad-dev:
        name: Deploy foreldrepengesøknad til dev
        if: ${{ github.ref_name == 'master' }}
        needs: build-app
        uses: navikt/fp-gha-workflows/.github/workflows/deploy-app-pnpm.yml@main
        with:
            image: ghcr.io/${{ github.repository }}/foreldrepengesoknad:${{ needs.build-app.outputs.build-version }}
            cluster: dev-gcp
            app: foreldrepengesoknad
        secrets: inherit

    promote-foreldrepengesoknad-prod:
        name: Deploy foreldrepengesøknad til prod
        if: ${{ github.ref_name == 'master' }}
        needs: [promote-foreldrepengesoknad-dev, build-app]
        uses: navikt/fp-gha-workflows/.github/workflows/deploy-app-pnpm.yml@main
        with:
            image: ghcr.io/${{ github.repository }}/foreldrepengesoknad:${{ needs.build-app.outputs.build-version }}
            cluster: prod-gcp
            app: foreldrepengesoknad
        secrets: inherit

    promote-foreldrepengeoversikt-dev:
        name: Deploy foreldrepengeoversikt til dev
        if: ${{ github.ref_name == 'master' }}
        needs: build-app
        uses: navikt/fp-gha-workflows/.github/workflows/deploy-app-pnpm.yml@main
        with:
            image: ghcr.io/${{ github.repository }}/foreldrepengeoversikt:${{ needs.build-app.outputs.build-version }}
            cluster: dev-gcp
            app: foreldrepengeoversikt
        secrets: inherit

    promote-foreldrepengeoversikt-prod:
        name: Deploy foreldrepengeoversikt til prod
        if: ${{ github.ref_name == 'master' }}
        needs: [promote-foreldrepengeoversikt-dev, build-app]
        uses: navikt/fp-gha-workflows/.github/workflows/deploy-app-pnpm.yml@main
        with:
            image: ghcr.io/${{ github.repository }}/foreldrepengeoversikt:${{ needs.build-app.outputs.build-version }}
            cluster: prod-gcp
            app: foreldrepengeoversikt
        secrets: inherit

    promote-engangsstonad-dev:
        name: Deploy engangsstonad til dev
        if: ${{ github.ref_name == 'master' }}
        needs: build-app
        uses: navikt/fp-gha-workflows/.github/workflows/deploy-app-pnpm.yml@main
        with:
            image: ghcr.io/${{ github.repository }}/engangsstonad:${{ needs.build-app.outputs.build-version }}
            cluster: dev-gcp
            app: engangsstonad
        secrets: inherit

    promote-engangsstonad-prod:
        name: Deploy engangsstonad til prod
        if: ${{ github.ref_name == 'master' }}
        needs: [promote-engangsstonad-dev, build-app]
        uses: navikt/fp-gha-workflows/.github/workflows/deploy-app-pnpm.yml@main
        with:
            image: ghcr.io/${{ github.repository }}/engangsstonad:${{ needs.build-app.outputs.build-version }}
            cluster: prod-gcp
            app: engangsstonad
        secrets: inherit

    promote-svangerskapspengesoknad-dev:
        name: Deploy svangerskapspengesoknad til dev
        if: ${{ github.ref_name == 'master' }}
        needs: build-app
        uses: navikt/fp-gha-workflows/.github/workflows/deploy-app-pnpm.yml@main
        with:
            image: ghcr.io/${{ github.repository }}/svangerskapspengesoknad:${{ needs.build-app.outputs.build-version }}
            cluster: dev-gcp
            app: svangerskapspengesoknad
        secrets: inherit

    promote-svangerskapspengesoknad-prod:
        name: Deploy svangerskapspengesoknad til prod
        if: ${{ github.ref_name == 'master' }}
        needs: [promote-svangerskapspengesoknad-dev, build-app]
        uses: navikt/fp-gha-workflows/.github/workflows/deploy-app-pnpm.yml@main
        with:
            image: ghcr.io/${{ github.repository }}/svangerskapspengesoknad:${{ needs.build-app.outputs.build-version }}
            cluster: prod-gcp
            app: svangerskapspengesoknad
        secrets: inherit
